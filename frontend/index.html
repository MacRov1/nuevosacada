<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Introducci√≥n a los sistemas de control 2025</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/style.css" />
</head>
<body class="d-flex flex-column align-items-center p-5 bg-light">
  <!-- Encabezado -->
  <header class="mb-5 text-center">
    <h1 class="fw-bold text-dark">Introducci√≥n a los sistemas de control 2025</h1>
    <p class="text-muted">SCADA Sem√°foro</p>
  </header>

  <!-- Contenedor principal -->
  <div class="d-flex flex-wrap justify-content-between w-75 mx-auto">

    <!-- Panel de Stream -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-3 text-secondary">Stream desde MediaMTX (pasando por Node)</h2>
      <video id="player" autoplay playsinline controls style="width:100%;border:1px solid #333;"></video>
    </div>

    <!-- Panel del Sem√°foro -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Sem√°foro Activar/Apagar (Mantenimiento)</h2>
      <div class="d-flex justify-content-around mb-4">
        <button id="activar" class="btn btn-success px-4">Activar</button>
        <button id="apagar" class="btn btn-danger px-4">Apagar</button>
      </div>
      <p id="mantenimiento-status" class="fw-semibold fs-5 text-secondary">‚Ä¢ Estado: E0</p>
      <div id="traffic-light" class="traffic-light mb-3 d-flex flex-column align-items-center">
        <div id="red" class="bulb red"></div>
        <div id="yellow" class="bulb yellow"></div>
        <div id="green" class="bulb green"></div>
      </div>
      <p id="semaforo-status" class="fw-semibold fs-5 text-secondary">Estado: E0</p>
    </div>

    <!-- Panel LCD -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Control de LCD</h2>
      <div class="d-flex justify-content-around mb-4">
        <input type="text" id="lcdInput" class="form-control" placeholder="Mensaje (m√°x 32 chars)" maxlength="32" />
        <button id="sendLcd" class="btn btn-primary px-4 ms-2">Enviar</button>
      </div>
      <p id="lcd-status" class="fw-semibold fs-5 text-secondary">Estado: Desconectado</p>
    </div>

    <!-- Panel LEDs WS2812 -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Control de LEDs WS2812</h2>
      <div class="d-flex justify-content-around mb-4">
        <select id="wsColor" class="form-select">
          <option value="verde">Verde</option>
          <option value="rojo">Rojo</option>
          <option value="azul">Azul</option>
          <option value="naranja">Naranja</option>
          <option value="amarillo">Amarillo</option>
          <option value="celeste">Celeste</option>
          <option value="violeta">Violeta</option>
          <option value="rosa">Rosado</option>
          <option value="blanco">Blanco</option>
          <option value="magenta">Magenta</option>
        </select>
        <button id="sendWs" class="btn btn-primary px-4 ms-2">Enviar</button>
      </div>
      <p id="ws-status" class="fw-semibold fs-5 text-secondary">Estado: Desconectado</p>
    </div>

    <!-- Panel Motor DC (Puente H con L293D) -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Motor DC - Puente H (BJT)</h2>

      <div class="d-flex justify-content-around mb-3">
        <button id="motorOn" class="btn btn-success px-4">Encender</button>
        <button id="motorOff" class="btn btn-outline-danger px-4">Apagar</button>
      </div>

      <div class="d-flex justify-content-around mb-3">
        <button id="motorCW" class="btn btn-outline-primary px-4">Antihorario</button>
        <button id="motorCCW" class="btn btn-outline-secondary px-4">Horario</button>
      </div>

      <div class="mb-3">
        <label for="motorSpeed" class="form-label">
          Velocidad PWM: <span id="motorSpeedVal">0</span>
        </label>
        <input type="range" class="form-range" min="0" max="255" step="1" id="motorSpeed" />
      </div>

      <p id="motorStatus" class="fw-semibold fs-5 text-secondary">Estado: off, 0</p>
    </div>

    <!-- Panel de Umbrales -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Umbrales de Temperatura</h2>
      <div class="d-flex justify-content-around mb-3">
        <input type="number" id="umbralNormal" class="form-control" placeholder="Normal (¬∞C)" />
        <input type="number" id="umbralAdvertencia" class="form-control" placeholder="Advertencia (¬∞C)" />
        <input type="number" id="umbralRiesgo" class="form-control" placeholder="Riesgo (¬∞C)" />
        <button id="sendUmbrales" class="btn btn-primary px-3 ms-2">Actualizar</button>
      </div>
      <div id="umbrales-actuales" class="mb-2">
        <p>Normal: <span id="valorNormal">-</span> ¬∞C</p>
        <p>Advertencia: <span id="valorAdvertencia">-</span> ¬∞C</p>
        <p>Riesgo: <span id="valorRiesgo">-</span> ¬∞C</p>
      </div>
      <p id="umbral-status" class="fw-semibold fs-5 text-secondary">Estado: No actualizado</p>
    </div>

  </div>

        <!-- Panel ESP32: Escaneo de Redes Wi-Fi -->
      <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 100%;">
        <h2 class="mb-4 text-secondary">Redes Wi-Fi detectadas por ESP32</h2>
        <button id="scanWifi" class="btn btn-primary mb-3">üîç Forzar nuevo escaneo</button>
        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>SSID</th>
                <th>BSSID (MAC)</th>
                <th>Canal</th>
                <th>RSSI (dBm)</th>
                <th>Cifrado</th>
              </tr>
            </thead>
            <tbody id="wifiTableBody">
              <tr><td colspan="6" class="text-muted">Esperando datos del ESP32...</td></tr>
            </tbody>
          </table>
        </div>
      </div>


  <!-- Panel de mensajes desde MCU -->
  <div class="card shadow-sm p-3 rounded-4 mt-4 bg-light text-dark w-75 mx-auto">
    <h5>Mensajes desde MCU:</h5>
    <ul id="mcu-log"></ul>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // -------------------- Elementos --------------------
    const activarBtn = document.getElementById("activar");
    const apagarBtn = document.getElementById("apagar");
    const mantenimientoStatus = document.getElementById("mantenimiento-status");
    const semaforoStatus = document.getElementById("semaforo-status");
    const redBulb = document.getElementById("red");
    const yellowBulb = document.getElementById("yellow");
    const greenBulb = document.getElementById("green");
    const log = document.getElementById("mcu-log");

    const lcdInput = document.getElementById("lcdInput");
    const sendLcdBtn = document.getElementById("sendLcd");
    const lcdStatus = document.getElementById("lcd-status");

    const wsColor = document.getElementById("wsColor");
    const sendWsBtn = document.getElementById("sendWs");
    const wsStatus = document.getElementById("ws-status");

    const motorOnBtn = document.getElementById("motorOn");
    const motorOffBtn = document.getElementById("motorOff");
    const motorCWBtn = document.getElementById("motorCW");
    const motorCCWBtn = document.getElementById("motorCCW");
    const motorSpeed = document.getElementById("motorSpeed");
    const motorSpeedVal = document.getElementById("motorSpeedVal");
    const motorStatus = document.getElementById("motorStatus");

    const umbralNormalInput = document.getElementById("umbralNormal");
    const umbralAdvertenciaInput = document.getElementById("umbralAdvertencia");
    const umbralRiesgoInput = document.getElementById("umbralRiesgo");
    const sendUmbralesBtn = document.getElementById("sendUmbrales");
    const umbralStatus = document.getElementById("umbral-status");
    const valorNormal = document.getElementById("valorNormal");
    const valorAdvertencia = document.getElementById("valorAdvertencia");
    const valorRiesgo = document.getElementById("valorRiesgo");

    let ultimoUmbral = { normal: null, advertencia: null, riesgo: null };

    // -------------------- Umbrales --------------------
    socket.on('umbrales-update', (msg) => {
      const [normal, advertencia, riesgo] = msg.split(',').map(Number);
      if (
        normal !== ultimoUmbral.normal ||
        advertencia !== ultimoUmbral.advertencia ||
        riesgo !== ultimoUmbral.riesgo
      ) {
        umbralNormalInput.value = normal;
        umbralAdvertenciaInput.value = advertencia;
        umbralRiesgoInput.value = riesgo;
        valorNormal.textContent = normal;
        valorAdvertencia.textContent = advertencia;
        valorRiesgo.textContent = riesgo;
        ultimoUmbral = { normal, advertencia, riesgo };
        umbralStatus.textContent = 'Estado: Umbrales actualizados';
      }
    });

    socket.on('umbral-response', (msg) => {
      umbralStatus.textContent = msg;
    });

    sendUmbralesBtn.addEventListener("click", () => {
      const normal = parseFloat(umbralNormalInput.value);
      const advertencia = parseFloat(umbralAdvertenciaInput.value);
      const riesgo = parseFloat(umbralRiesgoInput.value);
      if (!isNaN(normal) && !isNaN(advertencia) && !isNaN(riesgo)) {
        const payload = `${normal},${advertencia},${riesgo}`;
        socket.emit("umbral-message", {
          topic: "equipo1/isc2025/umbral",
          payload: payload
        });
        umbralStatus.textContent = `Estado: Enviando ${payload}...`;
      } else {
        umbralStatus.textContent = "Estado: Ingresa valores v√°lidos";
      }
    });

        // =====================================================================
        //ESP32 - Mostrar redes Wi-Fi escaneadas
        // =====================================================================
        const scanWifiBtn = document.getElementById("scanWifi");
        const wifiTableBody = document.getElementById("wifiTableBody");

        let scanBuffer = [];
        let isScanning = false;

        // Iniciar escaneo manual
        scanWifiBtn.addEventListener("click", () => {
          socket.emit("esp32-command", "SCAN_WIFI");
          scanBuffer = [];
          isScanning = true;
          wifiTableBody.innerHTML = '<tr><td colspan="6" class="text-muted">Escaneando...</td></tr>';
        });

        // RECIBIR CADA L√çNEA
        socket.on("esp32-message", (msg) => {
          const line = msg.trim();
          console.log("ESP32:", line);

          // Si estamos en modo escaneo, acumular
          if (isScanning) {
            scanBuffer.push(line);

            
            if (line === "Fin del escaneo.") {
              isScanning = false;
              parseAndRenderWifi(scanBuffer);
            }
          }
          // Si NO estamos escaneando, pero llega "Iniciando escaneo...", activar modo buffer
          else if (line === "Iniciando escaneo...") {
            scanBuffer = [line];
            isScanning = true;
            wifiTableBody.innerHTML = '<tr><td colspan="6" class="text-muted">Escaneando...</td></tr>';
          }
        });

        // PROCESAR Y MOSTRAR
        function parseAndRenderWifi(lines) {
          const networks = [];
          let current = {};

          lines.forEach((line) => {
            if (line.startsWith("Red #")) {
              if (Object.keys(current).length > 0) {
                networks.push(current);
              }
              current = {};
            } else if (line.startsWith("SSID:")) {
              current.ssid = line.substring(5).trim();
            } else if (line.startsWith("BSSID:")) {
              current.bssid = line.substring(6).trim();
            } else if (line.startsWith("Canal:")) {
              current.canal = line.substring(6).trim();
            } else if (line.startsWith("RSSI:")) {
              current.rssi = line.replace("RSSI:", "").replace("dBm", "").trim();
            } else if (line.startsWith("Cifrado:")) {
              current.cifrado = line.substring(8).trim();
            }
          });

          // √öltima red
          if (Object.keys(current).length > 0) {
            networks.push(current);
          }

          // Renderizar
          wifiTableBody.innerHTML = "";
          if (networks.length === 0) {
            wifiTableBody.innerHTML = '<tr><td colspan="6" class="text-muted">No se detectaron redes.</td></tr>';
          } else {
            networks.forEach((net, i) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${i + 1}</td>
                <td>${net.ssid || "-"}</td>
                <td>${net.bssid || "-"}</td>
                <td>${net.canal || "-"}</td>
                <td>${net.rssi || "-"}</td>
                <td>${net.cifrado || "-"}</td>
              `;
              wifiTableBody.appendChild(row);
            });
          }
        }
      //---------------------------------------------------------------------------------------
      
    // -------------------- Sem√°foro --------------------
    activarBtn.addEventListener("click", () => socket.emit("activar"));
    apagarBtn.addEventListener("click", () => socket.emit("apagar"));

    socket.on("semaforo-status", (state) => {
      let red = false, yellow = false, green = false;
      let statusText = state.replace(/On|Off/g, '').trim();
      let colorClass = "text-secondary";
      switch (state) {
        case "E0": red = true; colorClass = "text-danger"; break;
        case "E1": green = true; colorClass = "text-success"; break;
        case "E2": yellow = true; colorClass = "text-warning"; break;
        case "Mantenimiento": red = yellow = green = true; colorClass = "text-info"; break;
      }
      redBulb.style.backgroundColor = red ? "red" : "#ccc";
      yellowBulb.style.backgroundColor = yellow ? "yellow" : "#ccc";
      greenBulb.style.backgroundColor = green ? "green" : "#ccc";
      semaforoStatus.textContent = `Estado: ${statusText}`;
      semaforoStatus.className = `fw-semibold fs-5 ${colorClass}`;
    });

    // -------------------- LCD --------------------
    sendLcdBtn.addEventListener("click", () => {
      const message = lcdInput.value.trim();
      if (message) {
        socket.emit("lcd-message", { topic: "equipo1/isc2025/semaforo/lcd", payload: message });
      }
    });
    socket.on("lcd-response", (msg) => {
      lcdStatus.textContent = msg;
    });

    // -------------------- WS2812 --------------------
    sendWsBtn.addEventListener("click", () => {
      const color = wsColor.value;
      socket.emit("ws-message", { topic: "equipo1/isc2025/semaforo/ws", payload: color });
    });
    socket.on("ws-response", (msg) => {
      wsStatus.textContent = msg;
    });

    //------------------------- SEMANA 14 ------------------------------------------------------
    // -------------------- Motor DC (Puente H) --------------------
    motorOnBtn.addEventListener("click", () => socket.emit("motor-command", "motor:on"));
    motorOffBtn.addEventListener("click", () => socket.emit("motor-command", "motor:off"));
    motorCWBtn.addEventListener("click", () => socket.emit("motor-command", "motor:ho"));
    motorCCWBtn.addEventListener("click", () => socket.emit("motor-command", "motor:ah"));

    motorSpeed.addEventListener("input", () => {
      motorSpeedVal.textContent = motorSpeed.value;
    });
    motorSpeed.addEventListener("change", () => {
      socket.emit("motor-command", `motor:speed:${motorSpeed.value}`);
    });

    socket.on("motor-status", (payload) => {
      const parts = payload.split(',');
      const onoff = parts[0];
      const dir = parts[1] || '';
      const spd = parts[2] || '0';

      const dirText = dir === 'ho' ? 'HO' : dir === 'ah' ? 'AH' : '';
      motorStatus.textContent = `Estado: ${onoff}, ${dirText}, ${spd}`;

      motorSpeed.value = spd;
      motorSpeedVal.textContent = spd;

      // Resaltar bot√≥n activo
      if (dir === 'ho') {
        motorCWBtn.classList.remove('btn-outline-primary');
        motorCWBtn.classList.add('btn-primary');
        motorCCWBtn.classList.remove('btn-secondary');
        motorCCWBtn.classList.add('btn-outline-secondary');
      } else if (dir === 'ah') {
        motorCCWBtn.classList.remove('btn-outline-secondary');
        motorCCWBtn.classList.add('btn-secondary');
        motorCWBtn.classList.remove('btn-primary');
        motorCWBtn.classList.add('btn-outline-primary');
      } else {
        motorCWBtn.classList.remove('btn-primary');
        motorCWBtn.classList.add('btn-outline-primary');
        motorCCWBtn.classList.remove('btn-secondary');
        motorCCWBtn.classList.add('btn-outline-secondary');
      }
    });
    //-----------------------------------------------------------------------------------
    
    // -------------------- Log desde MCU --------------------
    socket.on("arduino-message", (msg) => {
      const li = document.createElement("li");
      li.textContent = msg;
      log.appendChild(li);
      log.scrollTop = log.scrollHeight;
    });
  </script>
</body>
</html>