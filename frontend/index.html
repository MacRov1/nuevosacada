<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Introducción a los sistemas de control 2025</title>
  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="assets/style.css" />
</head>

<body class="d-flex flex-column align-items-center p-5 bg-light">

  <!-- Encabezado -->
  <header class="mb-5 text-center">
    <h1 class="fw-bold text-dark">Introducción a los sistemas de control 2025</h1>
    <p class="text-muted">SCADA Semáforo</p>
  </header>

  <!-- Contenedor principal -->
  <div class="d-flex flex-wrap justify-content-between w-75 mx-auto">

    <!-- Panel de Stream -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-3 text-secondary">Stream desde MediaMTX (pasando por Node)</h2>
      <video id="player" autoplay playsinline controls style="width:100%;border:1px solid #333;"></video>
    </div>

    <!-- Panel del Semáforo -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Semáforo Activar/Apagar (Mantenimiento)</h2>

      <!-- Botones -->
      <div class="d-flex justify-content-around mb-4">
        <button id="activar" class="btn btn-success px-4">Activar</button>
        <button id="apagar" class="btn btn-danger px-4">Apagar</button>
      </div>

      <p id="mantenimiento-status" class="fw-semibold fs-5 text-secondary mb-4">• Estado: E0</p>

      <!-- Estado gráfico -->
      <div id="traffic-light" class="traffic-light mb-3 d-flex flex-column align-items-center">
        <div id="red" class="bulb red"></div>
        <div id="yellow" class="bulb yellow"></div>
        <div id="green" class="bulb green"></div>
      </div>

      <!-- Estado textual -->
      <p id="semaforo-status" class="fw-semibold fs-5 text-secondary">Estado: E0</p>
    </div>

    <!-- Panel LCD -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Control de LCD</h2>
      <div class="d-flex justify-content-around mb-4">
        <input
          type="text"
          id="lcdInput"
          class="form-control"
          placeholder="Mensaje (máx 32 chars)"
          maxlength="32"
        />
        <button id="sendLcd" class="btn btn-primary px-4 ms-2">Enviar</button>
      </div>
      <p id="lcd-status" class="fw-semibold fs-5 text-secondary">Estado: Desconectado</p>
    </div>

    <!-- Panel LEDs WS2812 -->
    <div class="card shadow-sm p-4 rounded-4 text-center bg-white mb-3" style="width: 48%;">
      <h2 class="mb-4 text-secondary">Control de LEDs WS2812</h2>
      <div class="d-flex justify-content-around mb-4">
        <select id="wsColor" class="form-select">
          <option value="verde">Verde</option>
          <option value="rojo">Rojo</option>
          <option value="azul">Azul</option>
          <option value="naranja">Naranja</option>
          <option value="amarillo">Amarillo</option>
          <option value="celeste">Celeste</option>
          <option value="violeta">Violeta</option>
          <option value="rosa">Rosado</option>
          <option value="blanco">Blanco</option>
          <option value="magenta">Magenta</option>
        </select>
        <button id="sendWs" class="btn btn-primary px-4 ms-2">Enviar</button>
      </div>
      <p id="ws-status" class="fw-semibold fs-5 text-secondary">Estado: Desconectado</p>
    </div>
  </div>

  <!-- Panel de mensajes desde MCU -->
  <div class="card shadow-sm p-3 rounded-4 mt-4 bg-light text-dark w-75 mx-auto">
    <h5>Mensajes desde MCU:</h5>
    <ul id="mcu-log"></ul>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>

  <script>
    const socket = io();

    // Elementos del semáforo
    const activarBtn = document.getElementById("activar");
    const apagarBtn = document.getElementById("apagar");
    const mantenimientoStatus = document.getElementById("mantenimiento-status");
    const semaforoStatus = document.getElementById("semaforo-status");
    const redBulb = document.getElementById("red");
    const yellowBulb = document.getElementById("yellow");
    const greenBulb = document.getElementById("green");
    const log = document.getElementById("mcu-log");

    // LCD
    const lcdInput = document.getElementById("lcdInput");
    const sendLcdBtn = document.getElementById("sendLcd");
    const lcdStatus = document.getElementById("lcd-status");

    // LEDs WS2812
    const wsColor = document.getElementById("wsColor");
    const sendWsBtn = document.getElementById("sendWs");
    const wsStatus = document.getElementById("ws-status");

    // --- SEMÁFORO ---
    activarBtn.addEventListener("click", () => socket.emit("activar"));
    apagarBtn.addEventListener("click", () => socket.emit("apagar"));

    socket.on("semaforo-status", (state) => {
      let red = false, yellow = false, green = false;
      let statusText = state.replace(/On|Off/g, '').trim();
      let colorClass = "text-secondary";

      switch (state) {
        case "E0": red = true; colorClass = "text-danger"; break;
        case "E1": green = true; colorClass = "text-success"; break;
        case "E2": yellow = true; colorClass = "text-warning"; break;
        case "Mantenimiento On": red = yellow = green = true; colorClass = "text-muted"; break;
        case "Mantenimiento Off": red = yellow = green = false; colorClass = "text-muted"; break;
        case "apagado": statusText = "apagado"; colorClass = "text-muted"; break;
        default: statusText = "desconocido";
      }

      redBulb.classList.toggle("on", red);
      yellowBulb.classList.toggle("on", yellow);
      greenBulb.classList.toggle("on", green);

      mantenimientoStatus.textContent = `• Estado: ${statusText}`;
      mantenimientoStatus.className = `fw-semibold fs-5 ${colorClass}`;
      semaforoStatus.textContent = `Estado: ${statusText}`;
      semaforoStatus.className = `fw-semibold fs-5 ${colorClass}`;
    });

    // --- LCD ---
    sendLcdBtn.addEventListener("click", () => {
      const msg = lcdInput.value.trim();
      if (msg) {
        socket.emit("lcd-message", { topic: "semaforo1/lcd", payload: msg });
        lcdInput.value = "";
        lcdStatus.textContent = "Estado: Enviando...";
      } else {
        lcdStatus.textContent = "Estado: Escribe un mensaje";
      }
    });

    socket.on("lcd-response", (response) => {
      lcdStatus.textContent = `Estado: ${response}`;
    });

    // --- LEDs WS2812 ---
    sendWsBtn.addEventListener("click", () => {
      const color = wsColor.value;
      socket.emit("ws-message", { topic: "semaforo1/ws", payload: color });
      wsStatus.textContent = "Estado: Enviando...";
    });

    socket.on("ws-response", (response) => {
      wsStatus.textContent = `Estado: ${response}`;
    });

    // --- Mensajes MCU ---
    socket.on("arduino-message", (msg) => {
      const li = document.createElement("li");
      li.textContent = msg;
      log.appendChild(li);
      log.scrollTop = log.scrollHeight;
    });

    // --- Estado de conexión ---
    socket.on("connect", () => {
      lcdStatus.textContent = "Estado: Conectado";
      wsStatus.textContent = "Estado: Conectado";
    });
    socket.on("disconnect", () => {
      lcdStatus.textContent = "Estado: Desconectado";
      wsStatus.textContent = "Estado: Desconectado";
    });
  </script>

  <!-- WebRTC Player -->
  <script>
    async function start() {
      const pc = new RTCPeerConnection();
      pc.addTransceiver("video", { direction: "recvonly" });
      pc.addTransceiver("audio", { direction: "recvonly" });

      const videoEl = document.getElementById("player");
      pc.ontrack = (event) => {
        videoEl.srcObject = event.streams[0];
      };

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      const resp = await fetch("/whep", {
        method: "POST",
        headers: { "Content-Type": "application/sdp" },
        body: offer.sdp,
      });

      const answerSdp = await resp.text();
      await pc.setRemoteDescription({ type: "answer", sdp: answerSdp });
      console.log("✅ Conexión WebRTC establecida");
    }

    start().catch(console.error);
  </script>

</body>
</html>
